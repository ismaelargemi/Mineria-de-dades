---
title: "Preprocessing"
author: "Iker Meneses Sales"
date: "2023-09-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preprocessing de los datos

Una vez hemos realizado la descriptiva preprocessing y hemos identificado el número de valores missing en nuestra base de datos, así como algunas variables categóricas a las cuales se les puede reducir el número de categorías y otras numéricas a las cuales se les puede aplicar alguna transformación lineal, es el momento de realizar estos cambios.

En primer lugar, se resolverán problemas relacionados con las variables numéricas. Como tenemos variables relacionadas con cantidades monetarias (salario, cantidad prestada...), tal vez sería mejor aplicar una transformación logarítmica: 

```{r, include = F, warning = F, message = F}
library(ggplot2)
library(dplyr)
library(corrplot)
library(cluster)

load("C:/Users/iker1/Downloads/Dades seleccionades.RData")
```

```{r}
df_final$log_AMT_INCOME_TOTAL = log(df_final$AMT_INCOME_TOTAL)
df_final$log_AMT_CREDIT = log(df_final$AMT_CREDIT)
df_final$log_AMT_ANNUITY = log(df_final$AMT_ANNUITY)
df_final$log_AMT_GOODS_PRICE = log(df_final$AMT_GOODS_PRICE)
```


Además, es de destacar cómo hay 47 individuos con un coche de 64 años y 11 con un coche de 65. Si nos fijamos en la distribución de esta variable, es muy extraño que haya tantos individuos con valores atípicos, ya que el siguiente valor máximo es 46. Así, se potará por imputar valores nulos a estos individuos:

```{r}
df_final$OWN_CAR_AGE[which(df_final$OWN_CAR_AGE == 64)] = NA
df_final$OWN_CAR_AGE[which(df_final$OWN_CAR_AGE == 65)] = NA
table(df_final$OWN_CAR_AGE)
```


Así pues, esta transformación debería resolver problemas relacionados con la normalidad de estas variables. Seguidamente, trataremos de resolver las variables categóricas con un número exagerado de categorías.


Para empezar, se puede apreciar que la variable `OCCUPATION_TYPE` tiene un total de 18 categorías:

```{r}
table(df_final$OCCUPATION_TYPE, useNA = "always")
```

Una buena idea sería combinar algunas categorías con el objetivo de reducir el número de categorías y, además, aumentar el número de individuos por categoría. Seguidamente, se muestran los cambios realizados:

-   Nueva categoría: `Auxiliar staff`, la cual englobará a "Medicine staff", "Security staff", "Waiters/barmen staff", "Cooking staff", "Private service staff", "Secretaries", "HR staff" y "Cleaning staff".
-   "Low-skill Laborers" se fusionará con "Laborers".
-   "IT staff" y "Realty agents" se unirán a "High skill tech staff"

```{r}
df_final$OCCUPATION_TYPE = as.character(df_final$OCCUPATION_TYPE)

df_final$OCCUPATION_TYPE[which(df_final$OCCUPATION_TYPE == "Medicine staff")] = "Auxiliar staff"
df_final$OCCUPATION_TYPE[which(df_final$OCCUPATION_TYPE == "Security staff")] = "Auxiliar staff"
df_final$OCCUPATION_TYPE[which(df_final$OCCUPATION_TYPE == "Waiters/barmen staff")] = "Auxiliar staff"
df_final$OCCUPATION_TYPE[which(df_final$OCCUPATION_TYPE == "Cooking staff")] = "Auxiliar staff"
df_final$OCCUPATION_TYPE[which(df_final$OCCUPATION_TYPE == "Private service staff")] = "Auxiliar staff"
df_final$OCCUPATION_TYPE[which(df_final$OCCUPATION_TYPE == "Secretaries")] = "Auxiliar staff"
df_final$OCCUPATION_TYPE[which(df_final$OCCUPATION_TYPE == "HR staff")] = "Auxiliar staff"
df_final$OCCUPATION_TYPE[which(df_final$OCCUPATION_TYPE == "Cleaning staff")] = "Auxiliar staff"

df_final$OCCUPATION_TYPE[which(df_final$OCCUPATION_TYPE == "Low-skill Laborers")] = "Laborers"

df_final$OCCUPATION_TYPE[which(df_final$OCCUPATION_TYPE == "IT staff")] = "High skill tech staff"
df_final$OCCUPATION_TYPE[which(df_final$OCCUPATION_TYPE == "Realty agents")] = "High skill tech staff"

df_final$OCCUPATION_TYPE = factor(df_final$OCCUPATION_TYPE)
```

Este proceso lo repetiremos con la variable `ORGANIZATION_TYPE`.

```{r}
table(df_final$ORGANIZATION_TYPE, useNA = "always")
```

Como se puede apreciar, en este caso disponemos de muchísimas categorías, pero es de destacar la categoría XNA, la cual deberíamos sustituir a NA, para después poder imputarle algún valor.

```{r}
a = as.character(df_final$ORGANIZATION_TYPE)

a[which(startsWith(a,"Trade"))] = "Trade"
a[which(startsWith(a,"Transp"))] = "Transport"
a[which(startsWith(a,"Transp"))] = "Transport"
a[which(startsWith(a,"Indus"))] = "Industry"
a[which(startsWith(a, "Business"))] = "Business"
a[which(startsWith(a,"Transp"))] = "Transport"
a[which(a == "XNA")] = NA

table(a, useNA = "always")

# Cambios a educación:

a[which(a == "School")] = "Education"
a[which(a == "University")] = "Education"
a[which(a == "Kindergarten")] = "Education"
a[which(a == "Culture")] = "Education"

a[which(a == "Security Ministries")] = "Security"
a[which(a == "Police")] = "Security"
a[which(a == "Emergency")] = "Security"
a[which(a == "Military")] = "Security"


a[which(a == "Postal")] = "Services"
a[which(a == "Cleaning")] = "Services"
a[which(a == "Restaurant")] = "Services"
a[which(a == "Advertising")] = "Services"
a[which(a == "Legal Services")] = "Services"
a[which(a == "Realtor")] = "Services"
a[which(a == "Hotel")] = "Services"
a[which(a == "Insurance")] = "Services"
a[which(a == "Bank")] = "Services"


a[which(a == "Housing")] = "Business"

a[which(a == "Mobile")] = "Other"
a[which(a == "Telecom")] = "Other"
a[which(a == "Religion")] = "Other"

a[which(a == "Electricity")] = "Construction"
df_final$ORGANIZATION_TYPE = factor(a)
```

Ahora, esta variable pasa a tener 13 categorías, las cuales representan los diferentes sectores presentes en la 
economía presente hoy en día.

### Imputación de valores

Seguidamente, pasaremos a imputar diferentes valores a aquellas variables donde hay observaciones sobre las cuales se desconocen sus valores reales. Este paso es necesario, ya que el hecho de disponer de valores desconocidos (también conocidos como NA) dificulta el análisis posterior de la variable. 

Una vez hemos recategorizado todas aquellas variables que presentaban problemas, el número de NA por variables es el siguiente:

```{r}
colSums(is.na(df_final))
```

Como se puede apreciar, necesitaremos un método de imputación mixto, ya que hay valores desconocidos tanto en variables categóricas como en numéricas. Así pues, se opta por el MICE:


```{r, echo=F, message=F}
library(mice)
factor_vars = c("CODE_GENDER", "NAME_INCOME_TYPE", "NAME_EDUCATION_TYPE", 
                "NAME_FAMILY_STATUS", "OCCUPATION_TYPE", "ORGANIZATION_TYPE", 
                "REGION_RATING_CLIENT", "TARGET")

num_vars = c("log_AMT_INCOME_TOTAL", "log_AMT_CREDIT", "log_AMT_ANNUITY", "DAYS_BIRTH",
             "OWN_CAR_AGE", "log_AMT_GOODS_PRICE", "CNT_FAM_MEMBERS")

x = c(factor_vars, num_vars)

dd <- df_final[, x]
mice_data = mice(dd)
df_preprocessed = complete(mice_data,1)
```


Cambiamos 

```{r}
summary(df_preprocessed)
```

Otro cambio a realizar es el respectivo a la variable `DAYS_BIRTH`, la cual muestra el número de días que lleva vivo el individuo. Sin embargo, el hecho de que esta variable esté en negativo y expresada en días (cuando normalmente se hace en años) hace que su interpretación sea complicada. De esta forma, se harán los cambios permanentes para encontrar la edad de los clientes, guardándola en una variable llamada `AGE_YEARS`:

```{r}
df_preprocessed$AGE_YEARS = floor(-df_preprocessed$DAYS_BIRTH/365)
```


Si queremos guardar la base de datos, sería necesario crear un nuevo dataset y exportarlo:

```{r}
factor_vars = c("CODE_GENDER", "NAME_INCOME_TYPE", "NAME_EDUCATION_TYPE", 
                "NAME_FAMILY_STATUS", "OCCUPATION_TYPE", "ORGANIZATION_TYPE", 
                "REGION_RATING_CLIENT", "TARGET")

num_vars = c("log_AMT_INCOME_TOTAL", "log_AMT_CREDIT", "log_AMT_ANNUITY", "AGE_YEARS",
             "OWN_CAR_AGE", "log_AMT_GOODS_PRICE", "CNT_FAM_MEMBERS")

x = c(factor_vars, num_vars)

df_final = df_preprocessed[,x]
```


```{r}
corr_mat = cor(df_final[,num_vars])
corrplot(corr_mat)

```

```{r}
num_vars = c("log_AMT_INCOME_TOTAL", "log_AMT_CREDIT", "log_AMT_ANNUITY", "AGE_YEARS",
             "OWN_CAR_AGE", "DIFF_CREDIT_PRICE", "CNT_FAM_MEMBERS")
df_final$DIFF_CREDIT_PRICE = df_final$log_AMT_CREDIT-df_final$log_AMT_GOODS_PRICE


corr_mat = cor(df_final[,num_vars])
corrplot(corr_mat)
```

```{r}
save(df_final, file = "Dades preprocessades.RData")
```