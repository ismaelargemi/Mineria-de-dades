---
output: pdf_document
header-includes:
  - \usepackage{fullpage} 
  - \usepackage[spanish]{babel}
  - \usepackage{fancyhdr}
  - \setlength{\headsep}{7mm} 
  - \usepackage[linktoc=page]{hyperref}
params:
  file1: "Dades seleccionades.RData"
  path: "C:/Users/iker1/Downloads"
---

<!-- estructura del documento -->

```{r, include=FALSE}
library(limma)
library(edgeR)

setwd(params$path)
file1 <- file.path(params$path,params$file1)
load(file1)
library(kableExtra)
View(df_final)

```

\pagenumbering{arabic}

```{=tex}
\begin{titlepage}
\centering
\graphicspath{{directori}}
\includegraphics[width=19cm, height=2cm]{logo3.png}

\begin{center}
\vspace*{3cm}

\Huge
    \textbf{Mineria de Datos}

\Huge
\textbf{Análisis Exploratorio de Datos y Predicción de Incumplimiento de
Préstamos}

\vspace{0.75cm}

\large
    \textbf{Aina Llaneras Casas, Alejandro Arcas Alberti,  Alessandro Natali Vilamú, Berta Moyano Núñez, Blanca Romero Sainz, Iker Meneses Sales, Ismael Argemí Fernández, Iván Martínez Yates, Marta Gomez de la Tia Privat, Mireia Bohils Tenas, Mireia Bolívar Rubia, Oscar Arroyo Luque, Letizia}
   
\vspace{0.5cm}
  \text{GRUPO 1: Aina Llaneras, Blanca Romero, Iván Martínez}
\vspace{0.02cm}
  \text{GRUPO 2: Alejandro Arcas Alberti, Alessandro Natali, Iker Meneses, Letizia}
\vspace{0.02cm}
  \text{GRUPO 3: Ismael Argemí, Mireia Bohils, Oscar Arroyo}
\vspace{0.02cm}
  \text{GRUPO 4: Berta Moyano, Marta Gómez, Mireia Bolívar}

    
\vspace{0.5cm}

\large
  \textit{23 de Septiembre del 2023}

\end{center}
\end{titlepage}
```
\newpage

```{=tex}
\setlength{\headheight}{13.6pt}
\setlength{\topmargin}{-10mm}
```
\pagestyle{fancy}

\fancyhf{}

```{=tex}
\rhead{Mineria de Datos}
\lhead{Entrega D1}
\newpage
```
```{=tex}
\cfoot{\thepage}
\setcounter{page}{1}
```
\pagebreak

# Definición del proyecto y asignación

El objetivo principal de este trabajo es permitir a las instituciones financieras o analistas de riesgos realizar un análisis exploratorio de datos completo para evaluar la probabilidad de que un prestatario incumpla con sus obligaciones financieras. Para un mejor funcionamiento del equipo y una correcta distribución de tareas, se ha separado el conjunto de los integrantes en 4 subgrupos mencionados previamente, cada uno constando de 3 integrantes, para poder efectuar las tareas con mayor asertividad e independencia.

## Fuente de obtención de los datos

Los datos se han extraído del repositorio de bases de datos Kaggle. El enlace de la página web es el siguiente: <https://www.kaggle.com/datasets/gauravduttakiit/loan-defaulter?select=application_data.csv>

## Descripción de los datos

Esta base de datos está diseñada para abordar el desafío de identificar posibles incumplimientos de préstamos en un entorno empresarial real. El conjunto de datos contiene información relacionada con préstamos otorgados a diversos prestatarios, junto con detalles financieros y personales de los solicitantes.

## Estructura e información de la matriz de datos

| **Filas (individuos)** | **Columnas (variables)** |         **Nro. variables numéricas**         |       **Nro. variables categóricas**        | **Nro. variables respuesta u objetivo** |
|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|
|   `r nrow(df_final)`   |    `r ncol(df_final)`    | `r sum(unlist(lapply(df_final,is.numeric)))` | `r sum(unlist(lapply(df_final,is.factor)))` |                    1                    |

**VARIABLES EXPLICATIVAS**

| **Nombre**              | **Descripción**                                                                             | **Tipo**   | **Diccionario y dominio**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|:----------------|:----------------|:----------------|:----------------------|
| CODE_GENDER             | Género del cliente                                                                          | Categórica | M---Male, F---Female                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| NAME \_INCOME \_TYPE    | Tipo de ingresos                                                                            | Categórica | 1-Businessman, 2-Commercial associate, 3-Pensioner, 4-State servant, 5-Working                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| NAME \_EDUCATION \_TYPE | Nivel de estudios del cliente                                                               | Categórica | 1-Academic degree, 2-Higher education, 3-Incomplete higher, 4-Lower secondary, 5-Secondary special                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| NAME \_FAMILY \_STATUS  | Estado civil                                                                                | Categórica | 1-Married, 2-Single/not married, 3-Civil marriage, 4-Separated, 5-Widow                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| OCCUPATION \_TYPE       | Actividad laboral                                                                           | Categórica | 1-Laborers, 2-Sales staff, 3-Core staff, 4-Managers, 5-Drivers, 6-Accountants, 7-Cleaning staff, 8- High skill tech staff, 9-HR staff, 10-IT staff, 11-Cooking staff, 12-Low-skill Laborers, 13-Medicine staff, 14-Private service staff, 15-Realty agents, 16-Security staff, 17-Secretaries, 18-Waiters/barmen staff                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ORGANIZATION \_TYPE     | Tipo de organización donde trabaja el cliente                                               | Categórica | 1-Advertising, 2-Agriculture, 3-Bank, 4-Business Entity Type 1, 5-Business Entity Type 2, 6-Business Entity Type 3, 7-Cleaning, 8-Construction, 9-Culture, 10-Electricity, 11-Emergency, 12-Government, 13-Hotel, 14-Housing, 15-Industry: type 1, 16-Industry: type 10, 17-Industry: type 11, 18-Industry: type 12, 19-Industry: type 13, 20-Industry: type 2, 21-Industry: type 3, 22-Industry: type 4, 23-Industry: type 5, 24-Industry: type 6, 25-Industry: type 7, 26-Industry: type 9, 27-Insurance, 28-Kindergarten, 29-Legal Services, 30-Medicine, 31-Military, 32-Mobile, 33-Other, 34-Police, 35-Postal, 36-Realtor, 37-Restaurant, 38-School, 39-Security, 40-Security Ministries, 41-Self-employed, 42-Services, 43-Telecom, 44-Trade: type 1, 45-Trade: type 2, 46-Trade: type 3, 47-Trade: type 4, 48-Trade: type 6, 49-Trade: type 7, 50-Transport: type 1, 51-Transport: type 2, 52-Transport: type 3, 53-Transport: type 4, 54-University, 55-XNA |
| REGION_RATING \_CLIENT  | Nuestra calificación de la región donde vive el cliente                                     | Categórica | 1, 2, 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| AMT_INCOME \_TOTAL      | Ingresos totales del cliente                                                                | Numérica   | [29250,2250000]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| AMT_CREDIT              | Importe de crédito del préstamo                                                             | Numérica   | [45000,3375000]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| AMT_ANNUITY             | Anualidad del préstamo                                                                      | Numérica   | [2673,177827]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| DAYS_BIRTH              | Edad del cliente en número de días en el momento de pedir el préstamo                       | Numérica   | [-25159,-7711]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| OWN_CAR_AGE             | Edad en años del coche del cliente                                                          | Numérica   | [0,65]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| AMT_GOODS \_PRICE       | Para préstamos al consumo, es el precio de los bienes para los cuales se otorga el préstamo | Numérica   | [45000,3375000]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| CNT_FAM \_MEMBERS       | Número de familiares del cliente                                                            | Numérica   | [1,8]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |

**VARIABLE OUTPUT**

| **Nombre** | **Descripción** | **Tipo**   | **Diccionario y dominio**                                                                                                                                                               |
|:----------------|:----------------|:----------------|:---------------------|
| Target     | Target          | Categórica | 1 - Cliente con dificultades de pago: él/ella tuvo pagos atrasados de más de X días en al menos una de las primeras Y cuotas del préstamo en nuestra muestra. 0 - Todos los demás casos |

**VARIABLES MISSINGS**

|          **Nro. de casillas missings**          |                           **Respeto del total de la matriz datos**                           |
|:------------------------:|:--------------------------------------------:|
| `` `r sum(is.na(df_final) | df_final == "")` `` | `` `r round(sum(is.na(df_final)| df_final == "")/(nrow(df_final)*ncol(df_final))*100,2)` ``% |

Porcentaje de missings por variable (tabla y histograma):

```{r, echo=FALSE}
#Percentatge missing per variable:
taula1 <- data.frame(Nro_de_missings = colSums(is.na(df_final)| df_final == ""),Porcentaje=round(colSums(is.na(df_final)| df_final == "")/nrow(df_final)*100,2))

```

|                 | **Nro. de missings**                             | **Porcentaje de missings**                    |
|------------------|-------------------|-----------------------------------|
| OWN_CAR_AGE     | `r taula1["OWN_CAR_AGE", "Nro_de_missings"]`     | `r taula1["OWN_CAR_AGE", "Porcentaje"]`%      |
| AMT_GOODS_PRICE | `r taula1["AMT_GOODS_PRICE", "Nro_de_missings"]` | `r taula1["AMT_GOODS_PRICE", "Porcentaje"]` % |
| OCCUPATION_TYPE | `r taula1["OCCUPATION_TYPE", "Nro_de_missings"]` | `r taula1["OCCUPATION_TYPE", "Porcentaje"]`%  |

```{r, echo=FALSE, warning=FALSE}
library(ggplot2)

missings <- taula1[,"Porcentaje"]!=0

m <- data.frame(Porcentaje=taula1$Porcentaje[missings])
rownames(m)<- c('OWN_CAR_AGE','AMT_GOODS_PRICE','OCCUPATION_TYPE')

ggplot(data = m, aes(x = rownames(m), y = Porcentaje), fill = rownames(m)) +
  geom_bar(stat="identity", fill="#5299E3", color="#5299E3") +
  labs(
    title = "Gráfico de porcentaje de missings",
    x = "Variables",
    y = "Porcentaje de missings"
  ) +
  theme_minimal() + 
  ylim(0,100)


```

Únicamente se han representado las variables que tienen algún valor faltante.

## Diagrama de Gantt

A continuación se muestra la descomposición de la práctica en tareas y su debida secuenciación en un diagrama de Gantt. El equipo ha sido dividido en cuatro subgrupos para que la carga de tareas quede debidamente repartida entre todos los integrantes. Seguidamente se muestran los miembros de cada uno de estos grupos:

-   Grupo A: Aina Llaneras, Blanca Romero, Ivan Martínez
-   Grupo B: Iker Meneses, Alejandro Arcas, Alessandro Natali, Arnaut Goethals
-   Grupo C: Oscar Arroyo, Ismael Argemí, Mireia Bohils
-   Grupo D: Marta Gómez, Mireia Bolívar, Berta Moyano

```{r, include = F}
library(googleVis)
datTL <- data.frame(Position=c("Planing y Distribución","Preprocessing y técnicas avanzadas", "Post preprocessing", "ACP y ACM", "Análisis factorial", "Clustering K-means y Jerarquico", "LDA y QDA", "Clustering avanzado" , "Basket market analysis" , "KNN", "Preparación primera exposición", "Primera exposición", "Arboles de decisión", "Random forest", "Naive Bayes", "SVM", "Ensemble methods", "Redes neuronales", "Conclusiones", "Preparación segunda exposición", "Segunda exposición"),
                    Name=c("Todos", "Grupo 1", "Grupo 2", "Grupo 3", "Grupo 4", "Grupo 2", "Grupo 3","Grupo 4","Grupo 2","Grupo 1","Todos","Todos", "Grupo 1","Grupo 3","Grupo 2", "Grupo 4","Grupo 3","Grupo 1","Todos","Todos","Todos"),
                    start=as.Date(x=c("2023-09-21", "2023-09-24", "2023-9-26", "2023-10-3" , "2023-10-05", "2023-10-5", "2023-10-7", "2023-10-17" , "2023-10-19" , "2023-10-26" , "2023-10-31" , "2023-11-09" , "2023-11-09", "2023-11-14" , "2023-11-21" , "2023-11-28" , "2023-12-05" , "2023-12-12", "2023-12-16" , "2023-12-16" , "2023-12-21"),),
                    end=as.Date(x=c("2023-09-24", "2023-09-28", "2023-09-28", "2023-10-5" , "2023-10-07", "2023-10-7", "2023-10-17" ,"2023-10-19" , "2023-10-26" ,"2023-11-5", "2023-11-09", "2023-11-09", "2023-11-14", "2023-11-21", "2023-11-28", "2023-12-05", "2023-12-12", "2023-12-16", "2023-12-21", "2023-12-21", "2023-12-21"),))

Timeline_Teoric <- gvisTimeline(data=datTL, 
                         rowlabel="Name",
                         barlabel="Position",
                         start="start", 
                         end="end",
                         options=list(timeline="{groupByRowLabel:false}",
                                      backgroundColor="#DCF0F8", 
                                      height=900,
                                      width=1300,
                                      colors="['#8AB8D0', '#307BA5', '#19506F']"),)
```


```{=tex}
\vspace{1cm}
\begin{center}
\textbf{Diagrama de Gantt}
\end{center}
```

```{=tex}
\begin{center}
```

```{=tex}
\includegraphics[width=19cm, height=15cm]{gantt.PNG}
```


```{=tex}
\end{center}
```

\newpage

## Análisis de riesgos

Se han identificado los siguientes riesgos que podrían afectar al correcto desarrollo del trabajo:

+------------------------+--------------+---------------------------+
| Posible problema       | Probabilidad | Solución                  |
|                        | de suceso    |                           |
|                        |              |                           |
+========================+==============+===========================+
| Tarea crítica no       | Baja         | Establecer una fecha      |
| finalizada a tiempo    |              | límite previa para tener  |
|                        |              | margen de maniobra        |
+------------------------+--------------+---------------------------+
| Falta y/o errores de   | Alta         | Canales de comunicación   |
| comunicación entre los |              | claros y efectivos y      |
| miembros del grupo     |              | designar un líder por     |
|                        |              | equipo                    |
+------------------------+--------------+---------------------------+
| Error en una tarea     | Media        | Tareas iniciales          |
| inicial que impida la  |              | revisadas por miembros de |
| correcta evolución     |              | otros grupos              |
|                        |              |                           |
|                        |              | Asignar a dos grupos para |
|                        |              | que trabajen de forma     |
|                        |              | simultánea                |
+------------------------+--------------+---------------------------+
| Ausencia temporal de   | Alta         | Un subgrupo dará soporte  |
| algun membro del       |              | para la finalización de   |
| equipo                 |              | la tarea a tiempo         |
|                        |              |                           |
|                        |              | Correcta explicación del  |
|                        |              | avance realizado al       |
|                        |              | integrante que ha faltado |
|                        |              | temporalmente             |
+------------------------+--------------+---------------------------+
| Ausencia permanente de | Baja         | Reasignación de los       |
| algun mienbro del      |              | integrantes del subgrupo  |
| equipo                 |              | en otro y redistribución  |
|                        |              | de las tareas.            |
+------------------------+--------------+---------------------------+

  
```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
#setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
options(scipen=999)
set.seed(1234)
libraries<- c("kableExtra","naniar","tidyverse",
              "scales","dplyr","lubridate","psych",
              "labelled","gridExtra","ggplot2","compareGroups",
              "lessR","ggcorrplot","class","cluster",
              "StatMatch","tidyverse","rio","NbClust",
              "dendextend","factoextra")

installifnot <- function (pckgName){
  if(!require(pckgName, character.only=TRUE)){
      install.packages(pckgName, dep=TRUE)
  }
}

for(i in libraries){
  installifnot(i)
  library(i, character.only = TRUE, quietly = TRUE)
}
```

```{r echo=FALSE, results = 'hide'}
load("Dades seleccionades.Rdata")
```

\newpage

```{r, echo = F, include = F}
bbc_style = function() 
{
  font <- "Helvetica"
  ggplot2::theme(plot.title = ggplot2::element_text(family = font, 
                                                    size = 18, face = "bold", color = "#222222"), plot.subtitle = ggplot2::element_text(family = font, 
                                                                                                                                        size = 15, margin = ggplot2::margin(2, 0, 5, 0)), plot.caption = ggplot2::element_blank(), 
                 legend.position = "top", legend.text.align = 0, legend.background = ggplot2::element_blank(), 
                 legend.title = ggplot2::element_blank(), legend.key = ggplot2::element_blank(), 
                 legend.text = ggplot2::element_text(family = font, size = 12, 
                                                     color = "#222222"), axis.title = ggplot2::element_blank(), axis.text.y = ggplot2::element_text(margin = ggplot2::margin(0,0,0,2)), 
                 axis.text = ggplot2::element_text(family = font, size = 10, 
                                                   color = "#222222"), 
axis.text.x = ggplot2::element_text(margin = ggplot2::margin(-5, b = 2)), axis.ticks = ggplot2::element_blank(), 
                 axis.line = ggplot2::element_blank(), panel.grid.minor = ggplot2::element_blank(), 
                 panel.grid.major.y = ggplot2::element_line(color = "#cbcbcb"), 
                 panel.grid.major.x = ggplot2::element_blank(), panel.background = ggplot2::element_blank(), 
                 strip.background = ggplot2::element_rect(fill = "white"), 
                 strip.text = ggplot2::element_text(size = 10, hjust = 0))
}
```


# ENTREGA D3

## Análisis Univariante 

Con la intención de realizar un buen análisis descriptivo univariante de los datos previo al pre-procesamiento se ha decidido integrar conjuntamente gráficos y tablas con resultados numéricos para lograr el mejor entendimiento de estos.

### Análisis Univariante Numérico


```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
kable(describe(select_if(df_final, is.numeric)),
      caption ="Descripción Univariante Variables Numéricas",
      align = "c",digits=2,booktabs = T) %>% 
  kable_styling(position = "center", 
                latex_options = c("HOLD_position","scale_down"),  font_size = 9)
```

Para comenzar, hemos creado una tabla que muestra varios estadísticos de todas las variables numéricas que hemos analizado. Además de los estadísticos más comunes, como la media o la desviación estándar, también hemos incluido otros estadísticos menos conocidos relacionados con la dispersión y centralización de los datos:

- 'Trimmed mean': Este es un estimador que calcula un estadístico para la variable al eliminar los valores más extremos de su distribución. En el caso de la 'Trimmed Mean', calcula la media de cada variable utilizando solo los datos que se encuentran en el intervalo [5%, 95%]. Al usar la 'Trimmed Mean', observamos que la variable "Amt credit" tiene una media similar a la mediana, lo que indica un alto grado de simetría.

- Skew: Este estadístico mide el grado de asimetría de la distribución. Toma valores positivos si la asimetría está hacia la derecha y negativos si está hacia la izquierda (es decir, si la media es menor que la mediana). Un alto grado de asimetría puede indicar la presencia de valores atípicos. Las variables "Amt annuity" y "Amt goods price" muestran una asimetría positiva.

- Kurtosis: La curtosis es una medida que determina cuán concentrados están los valores de una variable alrededor del centro de la distribución de frecuencias. Un valor de 3 es considerado como el nivel central de curtosis. Una distribución mesocúrtica tiene un cociente de asimetría igual a 3, leptocúrticas por encima de 3 y las platicúrticas por debajo de 3. Las variables "Amt annuity", "Own car age" y sobre todo "Amt income" tienen coeficientes de curtosis muy elevados, lo que indica distribuciones con colas muy pesadas.

- SE: El error estándar es la desviación estándar de la distribución muestral de un estadístico muestral. Es decir, es la desviación típica dividida por la raíz cuadrada del tamaño de la muestra (n). Tanto las variables "Amt credit" como "amt goods price" muestran una variabilidad muy alta.

```{r, echo = F, message=F,warning=F,fig.show='hide'}
data_n <- select_if(df_final, is.numeric)
q <- NULL
h <- NULL
s <- NULL
for(i in 1:ncol(data_n)){
 q[[i]] <- ggplot(data_n, aes_string(sample=names(data_n[i]))) + 
    stat_qq(col="#DCF0F8") + 
    stat_qq_line(col="#8B3E2F",lwd=1) + theme_bw() +
    xlab("Normal Theoretical Quantiles") + 
    ylab("Variable Data") + 
    ggtitle("Normal Q-Q Plot") + theme(plot.title = element_text(hjust = 0.5))
  h[[i]] <- ggplot(data_n, aes_string(x = data_n[,i])) + 
    geom_histogram(aes(y = after_stat(density)), color = "#53868B", fill = "#DCF0F8") +
    geom_density(color = "#8B3E2F",lwd=1) + 
    theme_bw() + xlab("") + ylab("Density") + 
    ggtitle(paste0("Histograma ", names(data_n)[i])) + 
    theme(plot.title = element_text(hjust = 0.5))
  s[[i]] <- shapiro.test(data_n[,i])$p.value[[1]]
}
```

```{r, echo = F, fig.cap = "Análisis Gráfico Variable AMT INCOME TOTAL", fig.show='asis', out.height="75%",out.width="75%"}
grid.arrange(h[[1]],q[[1]],ncol = 2)
```

Estos gráficos muestran que los datos de la variable "Amt income total" no siguen una distribución normal y parecen seguir una distribución exponencial. Esto tiene sentido, ya que la distribución de los ingresos totales de los individuos en una población generalmente no sigue una distribución normal. Además, al observar los resultados del test de normalidad "Shapiro-Wilk," se confirma la hipótesis anterior sobre la no normalidad de los datos, ya que el p-valor obtenido es `r s[[1]]`.

```{r, echo = F, fig.cap = "Análisis Gráfico Variable AMT CREDIT", fig.show='asis', out.height="75%",out.width="75%"}
grid.arrange(h[[2]],q[[2]],ncol = 2)
```

Al igual que en el caso anterior, la variable tampoco sigue una distribución normal, lo cual se confirma además por el test de Shapiro-Wilk con un p-valor de `r s[[2]]`. Parece que sigue una distribución exponencial o lognormal.

```{r, echo = F, fig.cap = "Análisis Gráfico Variable AMT ANNUITY",fig.show='asis',out.height="75%",out.width="75%"}
grid.arrange(h[[3]],q[[3]],ncol = 2)
```

Como en el caso interior, la variable sigue aparenta exponencial, con p-valor `r s[[3]]` del test de Shapiro Wilk.

```{r, echo = F, fig.cap = "Análisis Gráfico Variable DAYS BIRTH", fig.show='asis',out.height="75%",out.width="75%"}
grid.arrange(h[[4]],q[[4]],ncol = 2)
```

Como se puede apreciar en el histograma, la variable "Days Birth" presenta valores negativos. Esto se debe a que los datos indican la cantidad de días transcurridos desde el nacimiento del individuo hasta el momento en que solicitó el crédito. Por lo tanto, es necesario transformar los datos para que sean positivos y modificar la variable de manera que represente las edades de los sujetos en años, lo que facilitará un mejor tratamiento y comprensión de los resultados.

```{r, echo = F, fig.cap = "Análisis Gráfico Variable OWN CAR AGE", fig.show='hold',out.height="75%",out.width="75%"}
grid.arrange(h[[5]],q[[5]],ncol = 2)
```

En la variable 'Own car age', también se observa que no sigue una distribución normal, como lo demuestra el test de Shapiro-Wilk con un p-valor de `r s[[5]]`. Se puede notar una alta concentración de datos alrededor de los 10 años, lo que muestra una estructura similar a una distribución exponencial. Por otro lado, también se observa una fuerte concentración de datos en los 60 años, lo cual podría significar la existencia de valores desconocidos a los que se les ha etiquetado así.

```{r, echo = F, fig.cap = "Análisis Gráfico Variable AMT GOODS PRICE", fig.show='asis',out.height="75%",out.width="75%"}
grid.arrange(h[[6]],q[[6]],ncol = 2)
```

Al igual que en el caso anterior, la variable parece seguir una distribución exponencial, y la normalidad se rechaza con un p-valor de `r round(s[[6]],3)`. Aunque el Q-Q Plot y el histograma muestran una concentración de datos de forma periódica, una posible explicación podría ser que los bienes de alto costo tienden a tener precios redondeados o cantidades enteras en lugar de valores precisos. Por ejemplo, la moda podría ser `r sort(df_final$AMT_GOODS_PRICE)[nrow(data)/2]`.

```{r, echo = F, fig.cap = "Análisis Gráfico Variable CNT FAM MEMBERS", fig.show='asis',out.height="75%",out.width="75%"}
grid.arrange(h[[7]],q[[7]],ncol = 2)
```

La variable que representa el número de meimbros en la familia. Ésta, al ser discreta, no debe evaluarse como si siguiera una distribución normal. Aun así, es importante tener en cuenta que la mayoría de los clientes son núcleos unifamiliares.

### Análisis Univariante Categórico

Tras haber completado el análisis univariante numérico se procede a hacer el análisis categórico. Para ello, se realizará un análisis general y, posteriormente, se pasará a analizar una a una cada variable disponible. En la siguiente tabla se presenta un resumen general sobre ellas:

```{r,echo=F, fig.cap = "Tabla Summary Variables Categóricas"}
export2md(createTable(compareGroups(select_if(df_final,is.factor)), show.ratio=TRUE))
```

Por lo tanto, en la tabla se presentan tanto la frecuencia absoluta como la frecuencia relativa de cada valor posible en cada variable categórica, ya sean dicotómicas o politómicas. Esto facilita la identificación de la moda de manera sencilla.

Una vez se ha realizado un resumen general, se ha procedido a analizar cada variable una a una:

```{r echo = F, fig.show='hide',results = "hide"}
data_f <- select_if(df_final,is.factor)
# p <- NULL
# for(i in 1:ncol(data_f)){
#   var <- factor(data_f[,i])
#   PieChart(var, data = data.frame(var), hole = 0,
#          fill = hcl.colors(length(levels(var)),"pastel"),
#          labels_cex = 0.6, main = "",width = 2, height = 2)
#   p[[i]] <- recordPlot()
#   plot.new()
# }
```

```{r, warning = F, echo = F}
data = df_final
library(RColorBrewer)
p <- vector("list", length = ncol(data_f))

for (i in 1:ncol(data_f)) {
  var <- names(data_f)[i]
  freq_table <- table(data[[var]])
  num_classes <- length(freq_table)
  
  if (num_classes <= 5) {
    p[[i]] <- ggplot(data, aes(x = factor(1), fill = .data[[var]])) +
      geom_bar() +
      coord_polar(theta = "y") +
      labs(x = NULL, y = NULL, fill = var, title = var) + 
      theme_void() +
      theme(legend.position = "bottom") +
      scale_fill_brewer(palette = "muted")
      
  } else {
    
    datos = data.frame(data_f[var])
  
    names(datos) = "categoria"
  
    theTable <- within(datos, 
                   categoria <- factor(categoria, 
                                      levels=names(sort(table(categoria, useNA = "always"), 
                                                        decreasing=F))))
    
  
    df_graph = data.frame(prop = table(theTable$categoria, useNA = "always")/5000)
    
    p[[i]] <- ggplot(df_graph, aes(x = prop.Var1, y = prop.Freq)) +
      geom_bar(stat = "identity", fill = "skyblue") +
      geom_hline(yintercept = 0, linewidth = 0.8, colour="#333333") +
      labs(x = var, y = "Frecuencia relativa", title = var) +  
      theme_minimal() +
      scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
      bbc_style() +
      theme(axis.title = element_text(size = 14),
            title = element_text(size = 70),
            axis.text.x = element_text(angle = 45, hjust = 1, margin = margin(c(0,0,0,0))),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"), 
            panel.grid.major.y = ggplot2::element_blank(), panel.background = ggplot2::element_blank(),
            axis.text.y = ggplot2::element_text(margin = ggplot2::margin(c(0,-12,0,0)))) +
      labs(title = paste0("Distribución de la frecuencia relativa de ", var),
           y = "Frecuencia relativa",
           x = "Categorías") +
      coord_flip()
  }
}
```



```{r, echo = F, fig.cap= "Pie Chart CODE GENDER",fig.show='asis',out.width="75%",out.height="75%"}
p[[1]]
```

```{r, echo = F, fig.cap= "Pie Chart NAME INCOME TYPE",fig.show='hold',out.width="75%",out.height="75%"}
p[[2]]
```

```{r, echo = F, fig.cap= "Pie Chart NAME EDUCATION TYPE",fig.show='asis',out.width="75%",out.height="75%"}
p[[3]]
```

```{r, echo = F, fig.cap= "Pie Chart NAME FAMILY STATUS",fig.show='asis',out.width="75%",out.height="75%"}
p[[4]]
```

```{r, echo = F, fig.cap= "Distribucion OCCUPATION TYPE",fig.show='asis', fig.height=10, fig.width=10}
p[[5]]
```


```{r, echo = F, fig.cap= "Distribución ORGANIZATION TYPE",fig.show='asis', fig.height=10, fig.width=10}
p[[6]]
```

```{r, echo = F, fig.cap = "Pie chart REGION RATING CLIENT", fig.show='asis',out.height="75%",out.width="75%"}
p[[7]]
```

```{recho = F, fig.cap = "Pie Chart TARGET", fig.show='hold',out.height="75%",out.width="75%"}
p[[8]]
```



```{r, eval = F, fig.cap= "Pie Chart Variable Education",fig.show='hold',out.width="75%",out.height="75%"}
library(dplyr)
library(RColorBrewer)

org_type <- data_f %>%
  mutate(organization_group = case_when(
    grepl("Business Entity Type", ORGANIZATION_TYPE) ~ "Business Entity",
    grepl("Industry: type", ORGANIZATION_TYPE) ~ "Industry",
    grepl("Trade: type", ORGANIZATION_TYPE) ~ "Trade",
    grepl("Transport: type", ORGANIZATION_TYPE) ~ "Transport",
    grepl("Culture|Religion|Kindergarten", ORGANIZATION_TYPE) ~ "Culture/Religion/Kindergarten",
    grepl("Bank|Insurance", ORGANIZATION_TYPE) ~ "Finance/Insurance",
    TRUE ~ "Other"
  ))

mi_paleta <- brewer.pal(n = length(unique(org_type$organization_group)), name = "Set2")
p <- ggplot(org_type, aes(x = organization_group, fill = organization_group)) +
  geom_bar() +
  labs(x = "Organization Group", y = "Frecuencia") +
  scale_fill_manual(values = mi_paleta) +  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(p)
```


### Análisis Bivariante Numérico

Con el propósito de identificar las relaciones más significativas entre las variables numéricas, se ha creado un gráfico de correlación utilizando la técnica de HeatMap. En este gráfico, los colores indican el grado de dependencia entre las variables numéricas. Cuanto más intenso sea el color, mayor será la relación, y se prestará una mayor atención a estas relaciones en nuestro análisis.

```{r, echo = F, fig.cap="Matriz de Correlaciones para las Variables Numéricas", fig.show='hold'}
library(corrplot)

corr <- round(cor(select_if(df_final,is.numeric),use="complete.obs"), 2)
ggcorrplot(corr, hc.order = T,type = "lower",lab=T)
```

Tras analizar el gráfico, se destacan notables correlaciones entre las variables amt_credit y amt_goods_price. Esta correlación tiene sentido, ya que los prestamistas suelen otorgar créditos en función del valor del activo que el prestatario desea adquirir. En caso de impago, el prestamista retiene dicho activo como garantía. Además, se observa una alta correlación entre las variables amt_annuity y amt_credit. Esto se debe a que un mayor monto de crédito conlleva, de manera directa, una anualidad más elevada, especialmente cuando se busca un período de reembolso similar. También se aprecia una fuerte relación entre las variables amt_goods_price y amt_annuity, reflejando la conexión entre el crédito y el valor del activo.

```{r, echo=F, warning = F, message = F, fig.cap = "Scatterplot CREDIT vs GOODS PRICE", fig.show='hold',out.width="75%",out.height="75%"}

ggplot(data = df_final, aes(x = AMT_CREDIT, y = AMT_GOODS_PRICE)) + 
  geom_point(na.rm = T) +
  geom_hline(yintercept = 0, linewidth = 0.8, colour="#333333") +
  geom_smooth(method = "lm", se = FALSE, color = "coral2") +
  bbc_style() +
  scale_x_continuous(limits = c(0, 3000000),
                     breaks = seq(0, 3000000, by = 500000),
                     labels = c("0", "500000", "1000000", "1500000", "2000000", "2500000", "3000000")) +
  scale_y_continuous(limits = c(0, 3000000),
                     breaks = seq(0, 3000000, by = 500000),
                     labels = c("0", "500000", "1000000", "1500000", "2000000", "2500000", "3000000")) +
  theme(axis.title = element_text(size = 14),
        title = element_text(size = 70)) +
  labs(title = "Biplot AMT_CREDIT vs. AMT_GOODS_PRICE",
       subtitle = "",
       x = "Crédito pedido (en $)",
       y = "Precio de los bienes demandados (en $)")
```
En este gráfico se evidencia una fuerte correlación entre el valor del bien que el prestatario desea adquirir y la cantidad solicitada para el crédito. Es importante resaltar que los créditos de mayor cuantía muestran una correlación menor con el valor del bien, un aspecto que se explorará con mayor detalle en el transcurso del proyecto.

```{r, echo=F, warning = F, fig.cap = "Scatterplot ANNUITY vs GOODS PRICE", fig.show='hold',out.width="75%",out.height="75%"}
# plot(data$AMT_ANNUITY, data$AMT_GOODS_PRICE, pch = 19, col = "black",
#      xlab="AMT_ANNUITY", ylab="AMT_GOODS_PRICE")
# abline(lm(data$AMT_ANNUITY ~ data$AMT_GOODS_PRICE), col = "red", lwd = 3)
# text(paste("Correlación:", round(cor(data$AMT_ANNUITY, data$AMT_GOODS_PRICE), 2)),
#      x = 40, y = 20)


ggplot(data = df_final, aes(x = AMT_ANNUITY, y = AMT_GOODS_PRICE)) + 
  geom_point(na.rm = T) +
  geom_hline(yintercept = 0, linewidth = 0.8, colour="#333333") +
  geom_smooth(method = "lm", se = FALSE, color = "coral2") +  # Línea de regresión

  bbc_style() +
  scale_y_continuous(limits = c(0, 3000000),
                     breaks = seq(0, 3000000, by = 500000),
                     labels = c("0", "500000", "1000000", "1500000", "2000000", "2500000", "3000000")) +
  scale_x_continuous(limits = c(0, 200000),
                     breaks = seq(0, 200000, by = 50000),
                     labels = c("0", "50000", "100000", "150000", "200000")) +
  theme(axis.title = element_text(size = 14),
        title = element_text(size = 70)) +
  labs(title = "Biplot AMT_ANNUITY vs. AMT_GOODS_PRICE",
       subtitle = "",
       x = "Cantidad anual a pagar (en $)",
       y = "Precio de los bienes demandados (en $)")
```

De manera similar, la correlación entre el valor de los bienes y la anualidad también es bastante alta. Es importante señalar que los clientes que posean una relación entre la anualidad y el valor del bien que compren (teniendo en cuenta que el precio del bien es igual al valor del préstamo) serán aquellos que deban destinar una proporción menor de sus ingresos al reembolso de la deuda.


```{r}
ggplot(data = df_final, aes(x = AMT_ANNUITY, y = AMT_CREDIT)) + 
  geom_point(na.rm = T) +
  geom_hline(yintercept = 0, linewidth = 0.8, colour="#333333") +
  geom_smooth(method = "lm", se = FALSE, color = "coral2") +  # Línea de regresión

  bbc_style() +
  scale_y_continuous(limits = c(0, 3000000),
                     breaks = seq(0, 3000000, by = 500000),
                     labels = c("0", "500000", "1000000", "1500000", "2000000", "2500000", "3000000")) +
  scale_x_continuous(limits = c(0, 200000),
                     breaks = seq(0, 200000, by = 50000),
                     labels = c("0", "50000", "100000", "150000", "200000")) +
  theme(axis.title = element_text(size = 14),
        title = element_text(size = 70)) +
  labs(title = "Biplot AMT_ANNUITY vs. AMT_GOODS_PRICE",
       subtitle = "",
       x = "Cantidad anual a pagar (en $)",
       y = "Cantidad total solicitada (en $)")
```




### Análisis Bivariante Categórico-Descriptivo

Para concluir el análisis descriptivo antes de proceder al procesamiento de los datos, es necesario examinar la relación entre las variables categóricas y las numéricas. Para este propósito, utilizaremos la creación de varios boxplots, lo que nos permitirá presentar nuestras conclusiones de manera precisa y concisa.


```{r}
q <- list()

currelas <- c("CODE_GENDER", "NAME_INCOME_TYPE", "NAME_EDUCATION_TYPE", "NAME_FAMILY_STATUS", "OCCUPATION_TYPE", "ORGANIZATION_TYPE", "TARGET")

for (i in 1:length(currelas)){
  q[[i]] <- ggplot(df_final, aes(x = df_final[[currelas[i]]], fill = CODE_GENDER)) +
    geom_bar(position = "fill") +  
    labs(title = paste("Grouped Bar Chart:", currelas[i], "vs. CODE_GENDER"),
         x = currelas[i], y = "Proportion") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    scale_fill_manual(values = c("M" = "blue", "F" = "pink"))
}
```


```{r, echo = F, fig.cap = "Análisis Gráfico Variable OWN CAR AGE", fig.show='hold',out.height="75%",out.width="75%"}
q[[1]]
```


```{r, echo = F, fig.cap = "Análisis Gráfico Variable OWN CAR AGE", fig.show='hold', fig.width = 10, fig.height = 10}
library(sqldf)

data_graph = sqldf("SELECT OCCUPATION_TYPE, ORGANIZATION_TYPE, COUNT() AS N
                    FROM df_final
                    GROUP BY OCCUPATION_TYPE, ORGANIZATION_TYPE")


library(hrbrthemes)

heatmap = ggplot(data_graph, aes(x = OCCUPATION_TYPE, y = ORGANIZATION_TYPE, fill = N)) +
  geom_tile() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1), 
          panel.grid = element_blank()) 

heatmap
```


En este primer gráfico, se analiza el NAMEINCOME TYPE al sexo del cliente. Pese a ser un análisis interesante, vemos como el outlier dificulta mucho su estudio. Pese a ello, vemos como ...



